import { __assign, __awaiter, __decorate, __generator, __param } from "tslib";
import { Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { BehaviorSubject, fromEvent, interval, Subscription } from 'rxjs';
import { HttpClient } from '@angular/common/http';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * InjectionToken for specifing ConnectionService options.
 */
export var ConnectionServiceOptionsToken = new InjectionToken('ConnectionServiceOptionsToken');
export var DEFAULT_CONNECTION_STATE = {
    hasInternetAccess: true,
    hasNetworkConnection: window.navigator.onLine
};
export var DEFAULT_HEART_BEAT_INTERVAL = 1000;
// export const DEFAULT_HEART_BEAT_URL = 'https://jsonplaceholder.typicode.com';
export var DEFAULT_HEART_BEAT_URL = 'http://localhost:3000';
export var DEFAULT_HEART_BEAT_RETRY_INTERVAL = 1000;
export var HTTP_REQUEST_METHODS;
(function (HTTP_REQUEST_METHODS) {
    HTTP_REQUEST_METHODS["HEAD"] = "head";
    HTTP_REQUEST_METHODS["GET"] = "get";
    HTTP_REQUEST_METHODS["POST"] = "post";
    HTTP_REQUEST_METHODS["PUT"] = "put";
    HTTP_REQUEST_METHODS["OPTIONS"] = "options";
})(HTTP_REQUEST_METHODS || (HTTP_REQUEST_METHODS = {}));
export var DEFAULT_OPTIONS = {
    enableHeartbeat: false,
    heartbeatUrl: DEFAULT_HEART_BEAT_URL,
    heartbeatInterval: DEFAULT_HEART_BEAT_INTERVAL,
    heartbeatRetryInterval: 1000,
    requestMethod: HTTP_REQUEST_METHODS.HEAD
};
var ConnectionService = /** @class */ (function () {
    function ConnectionService(http, options) {
        this.http = http;
        this.currentState = DEFAULT_CONNECTION_STATE;
        this.serviceOptions = DEFAULT_OPTIONS;
        this.subscription = new Subscription();
        this.httpSubscription = new Subscription();
        this.stateChanged$ = new BehaviorSubject(DEFAULT_CONNECTION_STATE);
        // TODO: Token useValue in providers not working.
        this.serviceOptions = __assign(__assign({}, DEFAULT_OPTIONS), options);
        this.checkNetworkState();
        if (this.serviceOptions.enableHeartbeat) {
            this.checkInternetState();
        }
    }
    ConnectionService.prototype.checkNetworkState = function () {
        var _this = this;
        this.subscription.add(fromEvent(window, 'online').subscribe(function () {
            _this.currentState.hasNetworkConnection = true;
            _this.checkInternetState();
            _this.publishState();
        }));
        this.subscription.add(fromEvent(window, 'offline').subscribe(function () {
            _this.currentState.hasNetworkConnection = false;
            _this.checkInternetState();
            _this.publishState();
        }));
    };
    ConnectionService.prototype.checkInternetState = function () {
        var _this = this;
        if (this.serviceOptions.enableHeartbeat) {
            this.subscription = interval(3000).pipe(switchMap(function () { return __awaiter(_this, void 0, void 0, function () {
                var _this = this;
                return __generator(this, function (_a) {
                    return [2 /*return*/, this.http[this.serviceOptions.requestMethod || HTTP_REQUEST_METHODS.HEAD](this.serviceOptions.heartbeatUrl || DEFAULT_HEART_BEAT_URL, { responseType: 'text' }).subscribe({
                            next: function (data) {
                                _this.currentState.hasInternetAccess = true;
                                _this.publishState();
                            },
                            error: function (err) {
                                _this.currentState.hasInternetAccess = false;
                                _this.publishState();
                                throw err;
                            },
                        })];
                });
            }); })).subscribe(function (res) {
            });
            // this.httpSubscription = timer(0, this.serviceOptions.heartbeatInterval || DEFAULT_HEART_BEAT_INTERVAL)
            //   .pipe(
            //     switchMap(async () => this.http[this.serviceOptions.requestMethod || HTTP_REQUEST_METHODS.HEAD](this.serviceOptions.heartbeatUrl || DEFAULT_HEART_BEAT_URL,
            //       { responseType: 'text' })),
            //     retryWhen(errors =>
            //       errors.pipe(
            //         // log error message
            //         tap(val => {
            //           this.currentState.hasInternetAccess = false;
            //           this.publishState();
            //           throw errors;
            //         }),
            //         // restart after 5 seconds
            //         delay(this.serviceOptions.heartbeatRetryInterval || DEFAULT_HEART_BEAT_RETRY_INTERVAL)
            //       )
            //     )
            //   )
            //   .subscribe(result => {
            //     this.currentState.hasInternetAccess = true;
            //     this.publishState();
            //   });
        }
        else {
            this.currentState.hasInternetAccess = false;
            this.publishState();
        }
    };
    ConnectionService.prototype.publishState = function () {
        this.stateChanged$.next(this.currentState);
    };
    /**
   * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
   * function will not report current status of the connections when initially subscribed.
   * @param reportCurrentState Report current state when initial subscription. Default is "true"
   */
    ConnectionService.prototype.monitor = function (options) {
        if (options) {
            this.serviceOptions = __assign(__assign({}, this.serviceOptions), options);
        }
        if (this.serviceOptions.enableHeartbeat) {
            this.checkInternetState();
        }
        return this.stateChanged$;
    };
    ConnectionService.prototype.ngOnDestroy = function () {
        this.subscription.unsubscribe();
    };
    ConnectionService.ctorParameters = function () { return [
        { type: HttpClient },
        { type: undefined, decorators: [{ type: Inject, args: [ConnectionServiceOptionsToken,] }, { type: Optional }] }
    ]; };
    ConnectionService.ɵprov = i0.ɵɵdefineInjectable({ factory: function ConnectionService_Factory() { return new ConnectionService(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(ConnectionServiceOptionsToken, 8)); }, token: ConnectionService, providedIn: "root" });
    ConnectionService = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __param(1, Inject(ConnectionServiceOptionsToken)), __param(1, Optional())
    ], ConnectionService);
    return ConnectionService;
}());
export { ConnectionService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmctY29ubmVjdGlvbi1zZXJ2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9uZy1jb25uZWN0aW9uLXNlcnZpY2UvIiwic291cmNlcyI6WyJsaWIvbmctY29ubmVjdGlvbi1zZXJ2aWNlLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBYSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDeEYsT0FBTyxFQUFFLGVBQWUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFjLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0RixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7QUEyQzNDOztHQUVHO0FBQ0gsTUFBTSxDQUFDLElBQU0sNkJBQTZCLEdBQTZDLElBQUksY0FBYyxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFFM0ksTUFBTSxDQUFDLElBQU0sd0JBQXdCLEdBQW9CO0lBQ3ZELGlCQUFpQixFQUFFLElBQUk7SUFDdkIsb0JBQW9CLEVBQUUsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNO0NBQzlDLENBQUE7QUFFRCxNQUFNLENBQUMsSUFBTSwyQkFBMkIsR0FBRyxJQUFJLENBQUM7QUFDaEQsZ0ZBQWdGO0FBQ2hGLE1BQU0sQ0FBQyxJQUFNLHNCQUFzQixHQUFHLHVCQUF1QixDQUFDO0FBQzlELE1BQU0sQ0FBQyxJQUFNLGlDQUFpQyxHQUFHLElBQUksQ0FBQztBQUV0RCxNQUFNLENBQU4sSUFBWSxvQkFNWDtBQU5ELFdBQVksb0JBQW9CO0lBQzlCLHFDQUFhLENBQUE7SUFDYixtQ0FBVyxDQUFBO0lBQ1gscUNBQWEsQ0FBQTtJQUNiLG1DQUFXLENBQUE7SUFDWCwyQ0FBbUIsQ0FBQTtBQUNyQixDQUFDLEVBTlcsb0JBQW9CLEtBQXBCLG9CQUFvQixRQU0v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TEMsQUE1R0QsSUE0R0M7U0E1R1ksaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBJbmplY3Rpb25Ub2tlbiwgT25EZXN0cm95LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0LCBmcm9tRXZlbnQsIGludGVydmFsLCBPYnNlcnZhYmxlLCBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG4vKipcbiAqIEluc3RhbmNlIG9mIHRoaXMgaW50ZXJmYWNlIGlzIHVzZWQgdG8gcmVwb3J0IGN1cnJlbnQgY29ubmVjdGlvbiBzdGF0dXMuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29ubmVjdGlvblN0YXRlIHtcbiAgLyoqXG4gICAqIFwiVHJ1ZVwiIGlmIGJyb3dzZXIgaGFzIG5ldHdvcmsgY29ubmVjdGlvbi4gRGV0ZXJtaW5lZCBieSBXaW5kb3cgb2JqZWN0cyBcIm9ubGluZVwiIC8gXCJvZmZsaW5lXCIgZXZlbnRzLlxuICAgKi9cbiAgaGFzTmV0d29ya0Nvbm5lY3Rpb246IGJvb2xlYW47XG4gIC8qKlxuICAgKiBcIlRydWVcIiBpZiBicm93c2VyIGhhcyBJbnRlcm5ldCBhY2Nlc3MuIERldGVybWluZWQgYnkgaGVhcnRiZWF0IHN5c3RlbSB3aGljaCBwZXJpb2RpY2FsbHkgbWFrZXMgcmVxdWVzdCB0byBoZWFydGJlYXQgVXJsLlxuICAgKi9cbiAgaGFzSW50ZXJuZXRBY2Nlc3M6IGJvb2xlYW47XG59XG5cbi8qKlxuICogSW5zdGFuY2Ugb2YgdGhpcyBpbnRlcmZhY2UgY291bGQgYmUgdXNlZCB0byBjb25maWd1cmUgXCJDb25uZWN0aW9uU2VydmljZVwiLlxuICovXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBDb250cm9scyB0aGUgSW50ZXJuZXQgY29ubmVjdGl2aXR5IGhlYXJ0YmVhdCBzeXN0ZW0uIERlZmF1bHQgdmFsdWUgaXMgJ3RydWUnLlxuICAgKi9cbiAgZW5hYmxlSGVhcnRiZWF0PzogYm9vbGVhbjtcbiAgLyoqXG4gICAqIFVybCB1c2VkIGZvciBjaGVja2luZyBJbnRlcm5ldCBjb25uZWN0aXZpdHksIGhlYXJ0YmVhdCBzeXN0ZW0gcGVyaW9kaWNhbGx5IG1ha2VzIFwiSEVBRFwiIHJlcXVlc3RzIHRvIHRoaXMgVVJMIHRvIGRldGVybWluZSBJbnRlcm5ldFxuICAgKiBjb25uZWN0aW9uIHN0YXR1cy4gRGVmYXVsdCB2YWx1ZSBpcyBcIi8vaW50ZXJuZXRoZWFsdGh0ZXN0Lm9yZ1wiLlxuICAgKi9cbiAgaGVhcnRiZWF0VXJsPzogc3RyaW5nO1xuICAvKipcbiAgICogSW50ZXJ2YWwgdXNlZCB0byBjaGVjayBJbnRlcm5ldCBjb25uZWN0aXZpdHkgc3BlY2lmaWVkIGluIG1pbGxpc2Vjb25kcy4gRGVmYXVsdCB2YWx1ZSBpcyBcIjMwMDAwXCIuXG4gICAqL1xuICBoZWFydGJlYXRJbnRlcnZhbD86IG51bWJlcjtcbiAgLyoqXG4gICAqIEludGVydmFsIHVzZWQgdG8gcmV0cnkgSW50ZXJuZXQgY29ubmVjdGl2aXR5IGNoZWNrcyB3aGVuIGFuIGVycm9yIGlzIGRldGVjdGVkICh3aGVuIG5vIEludGVybmV0IGNvbm5lY3Rpb24pLiBEZWZhdWx0IHZhbHVlIGlzIFwiMTAwMFwiLlxuICAgKi9cbiAgaGVhcnRiZWF0UmV0cnlJbnRlcnZhbD86IG51bWJlcjtcbiAgLyoqXG4gICAqIEhUVFAgbWV0aG9kIHVzZWQgZm9yIHJlcXVlc3RpbmcgaGVhcnRiZWF0IFVybC4gRGVmYXVsdCBpcyAnaGVhZCcuXG4gICAqL1xuICByZXF1ZXN0TWV0aG9kPzogJ2dldCcgfCAncG9zdCcgfCAnaGVhZCcgfCAnb3B0aW9ucyc7XG5cbn1cblxuLyoqXG4gKiBJbmplY3Rpb25Ub2tlbiBmb3Igc3BlY2lmaW5nIENvbm5lY3Rpb25TZXJ2aWNlIG9wdGlvbnMuXG4gKi9cbmV4cG9ydCBjb25zdCBDb25uZWN0aW9uU2VydmljZU9wdGlvbnNUb2tlbjogSW5qZWN0aW9uVG9rZW48Q29ubmVjdGlvblNlcnZpY2VPcHRpb25zPiA9IG5ldyBJbmplY3Rpb25Ub2tlbignQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW4nKTtcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ09OTkVDVElPTl9TVEFURTogQ29ubmVjdGlvblN0YXRlID0ge1xuICBoYXNJbnRlcm5ldEFjY2VzczogdHJ1ZSxcbiAgaGFzTmV0d29ya0Nvbm5lY3Rpb246IHdpbmRvdy5uYXZpZ2F0b3Iub25MaW5lXG59XG5cbmV4cG9ydCBjb25zdCBERUZBVUxUX0hFQVJUX0JFQVRfSU5URVJWQUwgPSAxMDAwO1xuLy8gZXhwb3J0IGNvbnN0IERFRkFVTFRfSEVBUlRfQkVBVF9VUkwgPSAnaHR0cHM6Ly9qc29ucGxhY2Vob2xkZXIudHlwaWNvZGUuY29tJztcbmV4cG9ydCBjb25zdCBERUZBVUxUX0hFQVJUX0JFQVRfVVJMID0gJ2h0dHA6Ly9sb2NhbGhvc3Q6MzAwMCc7XG5leHBvcnQgY29uc3QgREVGQVVMVF9IRUFSVF9CRUFUX1JFVFJZX0lOVEVSVkFMID0gMTAwMDtcblxuZXhwb3J0IGVudW0gSFRUUF9SRVFVRVNUX01FVEhPRFMge1xuICBIRUFEID0gJ2hlYWQnLFxuICBHRVQgPSAnZ2V0JyxcbiAgUE9TVCA9ICdwb3N0JyxcbiAgUFVUID0gJ3B1dCcsXG4gIE9QVElPTlMgPSAnb3B0aW9ucydcbn1cblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfT1BUSU9OUzogQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zID0ge1xuICBlbmFibGVIZWFydGJlYXQ6IGZhbHNlLFxuICBoZWFydGJlYXRVcmw6IERFRkFVTFRfSEVBUlRfQkVBVF9VUkwsXG4gIGhlYXJ0YmVhdEludGVydmFsOiBERUZBVUxUX0hFQVJUX0JFQVRfSU5URVJWQUwsXG4gIGhlYXJ0YmVhdFJldHJ5SW50ZXJ2YWw6IDEwMDAsXG4gIHJlcXVlc3RNZXRob2Q6IEhUVFBfUkVRVUVTVF9NRVRIT0RTLkhFQURcbn07XG5cbkBJbmplY3RhYmxlKHtcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIENvbm5lY3Rpb25TZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcblxuICBwcml2YXRlIGN1cnJlbnRTdGF0ZTogQ29ubmVjdGlvblN0YXRlID0gREVGQVVMVF9DT05ORUNUSU9OX1NUQVRFO1xuICBwcml2YXRlIHNlcnZpY2VPcHRpb25zOiBDb25uZWN0aW9uU2VydmljZU9wdGlvbnMgPSBERUZBVUxUX09QVElPTlM7XG5cbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcbiAgcHJpdmF0ZSBodHRwU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgcHJpdmF0ZSBzdGF0ZUNoYW5nZWQkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxDb25uZWN0aW9uU3RhdGU+KERFRkFVTFRfQ09OTkVDVElPTl9TVEFURSk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50LCBASW5qZWN0KENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9uc1Rva2VuKSBAT3B0aW9uYWwoKSBvcHRpb25zOiBDb25uZWN0aW9uU2VydmljZU9wdGlvbnMpIHtcbiAgICAvLyBUT0RPOiBUb2tlbiB1c2VWYWx1ZSBpbiBwcm92aWRlcnMgbm90IHdvcmtpbmcuXG4gICAgdGhpcy5zZXJ2aWNlT3B0aW9ucyA9IHsgLi4uREVGQVVMVF9PUFRJT05TLCAuLi5vcHRpb25zIH07XG4gICAgdGhpcy5jaGVja05ldHdvcmtTdGF0ZSgpO1xuXG4gICAgaWYgKHRoaXMuc2VydmljZU9wdGlvbnMuZW5hYmxlSGVhcnRiZWF0KSB7XG4gICAgICB0aGlzLmNoZWNrSW50ZXJuZXRTdGF0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2hlY2tOZXR3b3JrU3RhdGUoKSB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzTmV0d29ya0Nvbm5lY3Rpb24gPSB0cnVlO1xuICAgICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcbiAgICAgIHRoaXMucHVibGlzaFN0YXRlKCk7XG4gICAgfSkpO1xuXG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKGZyb21FdmVudCh3aW5kb3csICdvZmZsaW5lJykuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc05ldHdvcmtDb25uZWN0aW9uID0gZmFsc2U7XG4gICAgICB0aGlzLmNoZWNrSW50ZXJuZXRTdGF0ZSgpO1xuICAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICB9KSk7XG4gIH1cblxuICBwcml2YXRlIGNoZWNrSW50ZXJuZXRTdGF0ZSgpIHtcblxuICAgIGlmICh0aGlzLnNlcnZpY2VPcHRpb25zLmVuYWJsZUhlYXJ0YmVhdCkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSBpbnRlcnZhbCgzMDAwKS5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoYXN5bmMgKCkgPT5cbiAgICAgICAgICB0aGlzLmh0dHBbdGhpcy5zZXJ2aWNlT3B0aW9ucy5yZXF1ZXN0TWV0aG9kIHx8IEhUVFBfUkVRVUVTVF9NRVRIT0RTLkhFQURdKHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0VXJsIHx8IERFRkFVTFRfSEVBUlRfQkVBVF9VUkwsXG4gICAgICAgICAgICB7IHJlc3BvbnNlVHlwZTogJ3RleHQnIH0pLnN1YnNjcmliZShcbiAgICAgICAgICAgICAge1xuICAgICAgICAgICAgICAgIG5leHQ6IChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IHRydWU7XG4gICAgICAgICAgICAgICAgICB0aGlzLnB1Ymxpc2hTdGF0ZSgpO1xuICAgICAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgICAgICBlcnJvcjogKGVycikgPT4ge1xuICAgICAgICAgICAgICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzSW50ZXJuZXRBY2Nlc3MgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgIHRoaXMucHVibGlzaFN0YXRlKCk7XG4gICAgICAgICAgICAgICAgICB0aHJvdyBlcnI7XG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApLnN1YnNjcmliZShcbiAgICAgICAgcmVzID0+IHtcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIC8vIHRoaXMuaHR0cFN1YnNjcmlwdGlvbiA9IHRpbWVyKDAsIHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0SW50ZXJ2YWwgfHwgREVGQVVMVF9IRUFSVF9CRUFUX0lOVEVSVkFMKVxuICAgICAgLy8gICAucGlwZShcbiAgICAgIC8vICAgICBzd2l0Y2hNYXAoYXN5bmMgKCkgPT4gdGhpcy5odHRwW3RoaXMuc2VydmljZU9wdGlvbnMucmVxdWVzdE1ldGhvZCB8fCBIVFRQX1JFUVVFU1RfTUVUSE9EUy5IRUFEXSh0aGlzLnNlcnZpY2VPcHRpb25zLmhlYXJ0YmVhdFVybCB8fCBERUZBVUxUX0hFQVJUX0JFQVRfVVJMLFxuICAgICAgLy8gICAgICAgeyByZXNwb25zZVR5cGU6ICd0ZXh0JyB9KSksXG4gICAgICAvLyAgICAgcmV0cnlXaGVuKGVycm9ycyA9PlxuICAgICAgLy8gICAgICAgZXJyb3JzLnBpcGUoXG4gICAgICAvLyAgICAgICAgIC8vIGxvZyBlcnJvciBtZXNzYWdlXG4gICAgICAvLyAgICAgICAgIHRhcCh2YWwgPT4ge1xuICAgICAgLy8gICAgICAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc0ludGVybmV0QWNjZXNzID0gZmFsc2U7XG4gICAgICAvLyAgICAgICAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICAgIC8vICAgICAgICAgICB0aHJvdyBlcnJvcnM7XG4gICAgICAvLyAgICAgICAgIH0pLFxuICAgICAgLy8gICAgICAgICAvLyByZXN0YXJ0IGFmdGVyIDUgc2Vjb25kc1xuICAgICAgLy8gICAgICAgICBkZWxheSh0aGlzLnNlcnZpY2VPcHRpb25zLmhlYXJ0YmVhdFJldHJ5SW50ZXJ2YWwgfHwgREVGQVVMVF9IRUFSVF9CRUFUX1JFVFJZX0lOVEVSVkFMKVxuICAgICAgLy8gICAgICAgKVxuICAgICAgLy8gICAgIClcbiAgICAgIC8vICAgKVxuICAgICAgLy8gICAuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XG4gICAgICAvLyAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzSW50ZXJuZXRBY2Nlc3MgPSB0cnVlO1xuICAgICAgLy8gICAgIHRoaXMucHVibGlzaFN0YXRlKCk7XG4gICAgICAvLyAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IGZhbHNlO1xuICAgICAgdGhpcy5wdWJsaXNoU3RhdGUoKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHB1Ymxpc2hTdGF0ZSgpIHtcbiAgICB0aGlzLnN0YXRlQ2hhbmdlZCQubmV4dCh0aGlzLmN1cnJlbnRTdGF0ZSk7XG4gIH1cblxuICAvKipcbiAqIE1vbml0b3IgTmV0d29yayAmIEludGVybmV0IGNvbm5lY3Rpb24gc3RhdHVzIGJ5IHN1YnNjcmliaW5nIHRvIHRoaXMgb2JzZXJ2ZXIuIElmIHlvdSBzZXQgXCJyZXBvcnRDdXJyZW50U3RhdGVcIiB0byBcImZhbHNlXCIgdGhlblxuICogZnVuY3Rpb24gd2lsbCBub3QgcmVwb3J0IGN1cnJlbnQgc3RhdHVzIG9mIHRoZSBjb25uZWN0aW9ucyB3aGVuIGluaXRpYWxseSBzdWJzY3JpYmVkLlxuICogQHBhcmFtIHJlcG9ydEN1cnJlbnRTdGF0ZSBSZXBvcnQgY3VycmVudCBzdGF0ZSB3aGVuIGluaXRpYWwgc3Vic2NyaXB0aW9uLiBEZWZhdWx0IGlzIFwidHJ1ZVwiXG4gKi9cbiAgcHVibGljIG1vbml0b3Iob3B0aW9ucz86IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyk6IE9ic2VydmFibGU8Q29ubmVjdGlvblN0YXRlPiB7XG4gICAgaWYgKG9wdGlvbnMpIHtcbiAgICAgIHRoaXMuc2VydmljZU9wdGlvbnMgPSB7IC4uLnRoaXMuc2VydmljZU9wdGlvbnMsIC4uLm9wdGlvbnMgfTtcbiAgICB9XG4gICAgaWYodGhpcy5zZXJ2aWNlT3B0aW9ucy5lbmFibGVIZWFydGJlYXQpIHtcbiAgICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLnN0YXRlQ2hhbmdlZCQ7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iXX0=